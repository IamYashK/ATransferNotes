| inputlookup DataDetails 
| join type=outer host index sourcetype 
    [| inputlookup DataDetails 
    | eval days_ago = relative_time(now(), "-20d@d")
    | search index=* 
    | search sourcetype!="*ecurity" 
    | search sourcetype!="*00ystem" 
    | search sourcetype!="*00pplication" 
    | stats count by host, index, sourcetype 
    | where count > 0 
    | foreach host index sourcetype [
        | makeresults 
        | eval host="$host$", index="$index$", sourcetype="$sourcetype$" 
        | eval days_ago=relative_time(now(),"-20d@d") 
        | search host=$host$ index=$index$ sourcetype=$sourcetype$ earliest=$days_ago$ 
        | head 1
        | eval expectedgap = "NA"
        | eval expectedgap = if(isnotnull(expectedgap), expectedgap, "NA")
        | map
            [| tstats count where host=$host$ index=$index$ sourcetype=$sourcetype$ by host _time span=1s 
            | timechart sum(count) span=1m by host cont=false 
            | delta _time as timediff 
            | search timediff > 0 
            | stats avg(timediff) as expectedgap 
            | eval expectedgap = round(expectedgap,0) 
            | eval expectedgap = expectedgap + 5000 
            | eval host="$host$", index="$index$", sourcetype="$sourcetype$" 
            | appendpipe 
                [ stats count 
                | eval expectedgap="FA" 
                | eval host="$host$", index="$index$", sourcetype="$sourcetype$"]] maxsearches=100 
        | table host index sourcetype expectedgap
    ]
    | inputlookup append=t DataDetails 
    | table host index sourcetype expectedgap
    ] 
| outputlookup DataDetails