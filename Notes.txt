$drives = Get-PSDrive -PSProvider 'FileSystem' 

# Loop through each drive
foreach ($drive in $drives) {
    # Define the output file path
    $outputFile = "D:\Z-Other\ScriptingTest\powershell\FileNSize\file_sizes_$($drive.Name).txt"

    # Check if the output file exists and delete it if it does
    if (Test-Path -Path $outputFile -PathType Leaf) {
        $file = Get-Item $outputFile
        $fileIsOpen = $false
        try {
            $fileStream = $file.Open([System.IO.FileMode]::Open, [System.IO.FileAccess]::ReadWrite, [System.IO.FileShare]::None)
        }
        catch {
            $fileIsOpen = $true
        }
        if ($fileStream) {
            $fileStream.Close()
        }
        if (-not $fileIsOpen) {
            Remove-Item -Path $outputFile
        }
    }

    # Create a FileStream object to open the output file
    $fileStream = New-Object System.IO.FileStream($outputFile, [System.IO.FileMode]::OpenOrCreate, [System.IO.FileAccess]::Write, [System.IO.FileShare]::ReadWrite)

    # Create a StreamWriter object to write to the output file
    $streamWriter = New-Object System.IO.StreamWriter($fileStream)

    # Get all the files in the current drive, including hidden and system files and folders
    $files = Get-ChildItem -Path $drive.Root -Recurse -File -Force

    # Loop through each file and write the name and size to the output file
    foreach ($file in $files) {
        $line = $file.FullName + "##-##" + $file.Length
        $streamWriter.WriteLine($line)
    }

    # Close the StreamWriter and FileStream objects
    $streamWriter.Close()
    $fileStream.Close()
}