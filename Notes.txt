import os
import pandas as pd

onprem_folder = "on-prem"
cloud_folder  = "cloud"
output_folder = "output"

compare_fields = ["host", "iid", "index", "sourcetype", "wf_id"]

os.makedirs(output_folder, exist_ok=True)

reports = []

for file in os.listdir(onprem_folder):
    if file.endswith(".csv"):

        onprem_file = os.path.join(onprem_folder, file)
        cloud_file  = os.path.join(cloud_folder,  file)

        if not os.path.exists(cloud_file):
            reports.append([file, "File missing", "onprem present", "cloud missing"])
            continue

        df_onprem = pd.read_csv(onprem_file, usecols=compare_fields)
        df_cloud  = pd.read_csv(cloud_file,  usecols=compare_fields)

        # convert rows to tuple so we can do set operations
        onprem_set = set(tuple(row) for row in df_onprem.to_numpy())
        cloud_set  = set(tuple(row) for row in df_cloud.to_numpy())

        common      = onprem_set & cloud_set
        only_onprem = onprem_set - cloud_set
        only_cloud  = cloud_set  - onprem_set

        # convert sets back to dataframe
        df_common      = pd.DataFrame(list(common), columns=compare_fields)
        df_only_onprem = pd.DataFrame(list(only_onprem), columns=compare_fields)
        df_only_cloud  = pd.DataFrame(list(only_cloud), columns=compare_fields)

        # file base name without extension
        base = os.path.splitext(file)[0]

        df_common.to_csv(os.path.join(output_folder, f"{base}_common.csv"), index=False)
        df_only_onprem.to_csv(os.path.join(output_folder, f"{base}_only_onprem.csv"), index=False)
        df_only_cloud.to_csv(os.path.join(output_folder, f"{base}_only_cloud.csv"), index=False)

        # summary
        reports.append([file, len(common), len(only_onprem), len(only_cloud)])


summary = pd.DataFrame(reports, columns=["file","common_rows","only_onprem_rows","only_cloud_rows"])
summary.to_csv(os.path.join(output_folder, "summary.csv"), index=False)
print(summary)
print("\nDone. Reports written to 'output' folder")
